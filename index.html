<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>SGK Vizite HTA</title>
    <!-- Bootstrap 4 CSS -->
     <link rel="icon" type="image/x-icon" href="https://cgnksktyqrdmkztszfaf.supabase.co/storage/v1/object/public/Vizite/icon.ico">
    <link rel="shortcut icon" href="https://cgnksktyqrdmkztszfaf.supabase.co/storage/v1/object/public/Vizite/icon.ico">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">


    <script src="https://cdn.jsdelivr.net/npm/core-js-bundle@3.6.5/minified.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/regenerator-runtime@0.13.7/runtime.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/whatwg-fetch@3.6.2/dist/fetch.umd.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuex@3/dist/vuex.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/handsontable@11.1.0/dist/handsontable.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@handsontable/vue@5.1.0/dist/vue-handsontable.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/handsontable@11.1.0/dist/handsontable.full.min.css" rel="stylesheet">

    <style>
        body { background-color: #f8f9fa; height: 100vh; margin: 0; padding: 0; }
        #app { min-height: 100vh; display: flex; flex-direction: column; padding: 0; margin: 0; }
        .login-section { padding: 20px; }
        .table-wrapper { max-height: calc(100vh - 250px); overflow-y: auto; }
        .vue-modal-overlay { position: fixed; top:0; left:0; width:100vw; height:100vh; background: rgba(0,0,0,0.3); display:flex; align-items:center; justify-content:center; z-index:9999; }
        .vue-modal-content { background:#fff; padding:24px; border-radius:8px; min-width:600px; max-width:1200px; box-shadow:0 4px 24px rgba(0,0,0,0.18); max-height:80vh; overflow-y:auto; }
        .status-success { color: #28a745; font-weight: bold; }
        .status-error { color: #dc3545; font-weight: bold; }
        .status-warning { color: #ffc107; font-weight: bold; }
        .row-clickable:hover { background-color: #f8f9fa; cursor: pointer; }
        .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .handsontable-container { height: 400px; margin: 20px 0; }
    </style>
</head>

<body>
    <div id="no-internet" style="display:none; height:100vh; align-items:center; justify-content:center; flex-direction:column; background:#fff; z-index:99999; position:fixed; top:0; left:0; width:100vw;">
        <div style="text-align:center;">
            <img src="icon.ico" alt="No Internet" style="width:80px; margin-bottom:24px;" />
            <h2 style="color:#dc3545;">İnternet bağlantısı yok</h2>
            <p style="font-size:18px; color:#333;">Uygulama çalışabilmek için internete ihtiyaç duyar.<br>Bağlantınızı kontrol edip tekrar deneyin.</p>
        </div>
    </div>
    <div id="app" class="container-fluid">
        <!-- Login Section with Handsontable -->
        <div v-if="!token" class="login-section">
            <div class="card shadow" style="height: calc(100vh - 100px);">
                <div class="card-header">
                    <h3 class="card-title text-center mb-0">İş Yeri Şifre Bilgileri</h3>
                </div>
                <div class="card-body h-100">
                        <hot-table
                            :settings="{
                                data: tableData,
                                colHeaders: colHeaders,
                                columns: columns,
                                licenseKey: 'non-commercial-and-evaluation',
                                stretchH: 'all',
                                manualColumnResize: true,
                                manualRowResize: true,
                                minSpareRows: 1,
                                rowHeaders: true,
                                width: '100%',
                                height: '100%',
                                colWidths: 100,
                                autoWrapRow: true,
                                autoWrapCol: true
                            }"
                            @afterChange="onTableChange"
                        >
                        </hot-table>
                    <div v-if="loginMessage" class="alert mt-3" :class="{'alert-success': loginSuccess, 'alert-danger': !loginSuccess}">
                        {{ loginMessage }}
                    </div>
                </div>
            </div>
        </div>
        <nav class="navbar navbar-default navbar-fixed-bottom" v-if="!token">
            <div class="container-fluid d-flex justify-content-between align-items-center">
                <div class="navbar-text">
                    <small class="text-muted">By. OKAN AVCU</small>
                </div>
            </div>
        </nav>
        <!-- Rapor ekranı -->
        <div v-else>
            <div class="card shadow">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">SGK Vizite HTA - {{ currentUser.isyeriAdi }}</h5>
                    <div>
                        <button @click="raporSorgula" class="btn btn-info btn-sm mr-2" :disabled="isLoading">
                            <span v-if="isLoading" class="loading-spinner"></span>
                            {{ isLoading ? 'Yenileniyor...' : 'Yenile' }}
                        </button>
                        <button @click="logout" class="btn btn-warning btn-sm">Çıkış</button>
                    </div>
                </div>
                <div class="card-body">
                    <div v-if="raporlar.length">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <input type="text" v-model="search" placeholder="Tabloda ara..." class="form-control">
                            </div>
                            <div class="col-md-6 text-right">
                                <small class="text-muted">Toplam {{ filteredRaporlar.length }} rapor</small>
                            </div>
                        </div>
                        <div class="table-wrapper">
                            <table class="table table-bordered table-striped table-sm">
                                <thead class="thead-light">
                                    <tr>
                                        <th>TCKN</th>
                                        <th>AD</th>
                                        <th>SOYAD</th>
                                        <th>RAPOR ID</th>
                                        <th>RAPOR TAKIP NO</th>
                                        <th>RAPOR SIRA NO</th>
                                        <th>POLİKLİNİK TARİHİ</th>
                                        <th>AYAKTA BAŞLANGIÇ TARİHİ</th>
                                        <th>AYAKTA BİTİŞ TARİHİ</th>
                                        <th>RAPOR DURUMU</th>
                                        <th>VAKA</th>
                                        <th>ARŞİV</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="r in filteredRaporlar" :key="r.MEDULARAPORID" @dblclick="showRapor(r)" class="row-clickable">
                                        <td>{{ r.TCKIMLIKNO }}</td>
                                        <td>{{ r.AD }}</td>
                                        <td>{{ r.SOYAD }}</td>
                                        <td>{{ r.MEDULARAPORID }}</td>
                                        <td>{{ r.RAPORTAKIPNO }}</td>
                                        <td>{{ r.RAPORSIRANO }}</td>
                                        <td>{{ formatDate(r.POLIKLINIKTAR) }}</td>
                                        <td>{{ formatDate(r.ABASTAR) }}</td>
                                        <td>{{ formatDate(r.ABITTAR) }}</td>
                                        <td>{{ r.RAPORDURUMU }}</td>
                                        <td>{{ r.VAKAADI }}</td>
                                        <td>{{ r.ARSIV ? '✅' : '❌' }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div v-else-if="!isLoading" class="text-center py-4">
                        <p class="mb-3">Rapor bulunamadı</p>
                    </div>
                    <div v-if="isLoading && !raporlar.length" class="text-center py-4">
                        <div class="loading-spinner" style="width: 40px; height: 40px; border-width: 4px;"></div>
                        <p class="mt-2">Raporlar yükleniyor...</p>
                    </div>
                </div>

                <!-- Vue Modal -->
                <div v-if="selectedRapor" class="vue-modal-overlay" @click.self="selectedRapor=null">
                    <div class="vue-modal-content">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Rapor Detayı</h5>
                            <button type="button" class="close" @click="selectedRapor=null">&times;</button>
                        </div>
                        <div class="row">
                            <div class="col-md-8">
                                <table class="table table-sm table-bordered">
                                    <tr><th>TCKN</th><td>{{ selectedRapor.TCKIMLIKNO }}</td></tr>
                                    <tr><th>Ad</th><td>{{ selectedRapor.AD }}</td></tr>
                                    <tr><th>Soyad</th><td>{{ selectedRapor.SOYAD }}</td></tr>
                                    <tr><th>Rapor ID</th><td>{{ selectedRapor.MEDULARAPORID }}</td></tr>
                                    <tr><th>Rapor Takip No</th><td>{{ selectedRapor.RAPORTAKIPNO }}</td></tr>
                                    <tr><th>Rapor Sıra No</th><td>{{ selectedRapor.RAPORSIRANO }}</td></tr>
                                    <tr><th>Poliklinik Tarihi</th><td>{{ formatDate(selectedRapor.POLIKLINIKTAR) }}</td></tr>
                                    <tr><th>Başlangıç Tarihi</th><td>{{ formatDate(selectedRapor.ABASTAR) }}</td></tr>
                                    <tr><th>Bitiş Tarihi</th><td>{{ formatDate(selectedRapor.ABITTAR) }}</td></tr>
                                    <tr><th>Durum</th><td>{{ selectedRapor.RAPORDURUMU }}</td></tr>
                                    <tr><th>Vaka</th><td>{{ selectedRapor.VAKAADI }}</td></tr>
                                    <tr><th>Arşiv</th><td>{{ selectedRapor.ARSIV ? '✅' : '❌' }}</td></tr>
                                </table>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">İşlemler</div>
                                    <div class="card-body">
                                        <div class="d-grid gap-2">
                                            <button type="button" class="btn btn-success btn-block mb-2" @click="modalRaporOnayla" :disabled="modalLoading">
                                                <span v-if="modalLoading === 'onayla'" class="loading-spinner"></span>
                                                {{ modalLoading === 'onayla' ? 'Onaylanıyor...' : 'Onayla' }}
                                            </button>
                                            <button type="button" class="btn btn-info btn-block mb-2" @click="modalRaporKapat" :disabled="modalLoading">
                                                <span v-if="modalLoading === 'kapat'" class="loading-spinner"></span>
                                                {{ modalLoading === 'kapat' ? 'Kapatılıyor...' : 'Oku ve Kapat' }}
                                            </button>
                                            <button type="button" class="btn btn-danger btn-block mb-2" @click="modalRaporPersonelimDegil" :disabled="modalLoading">
                                                <span v-if="modalLoading === 'personelim_degil'" class="loading-spinner"></span>
                                                {{ modalLoading === 'personelim_degil' ? 'İşleniyor...' : 'Personelim Değil' }}
                                            </button>
                                            <button type="button" class="btn btn-secondary btn-block" @click="selectedRapor=null" :disabled="modalLoading">Kapat</button>
                                        </div>
                                        <div v-if="modalMessage" class="alert mt-3" :class="{'alert-success': modalSuccess, 'alert-danger': !modalSuccess}">
                                            {{ modalMessage }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/babel">
    const { HotTable } = Handsontable.vue;
    
    const store = new Vuex.Store({
        state: {
            token: null,
            tokenExpiry: null,
            response: ''
        },
        mutations: {
            setToken(state, payload) {
                state.token = payload.token;
                state.tokenExpiry = payload.expiry;
            },
            clearToken(state) {
                state.token = null;
                state.tokenExpiry = null;
            },
            setResponse(state, val) {
                state.response = val;
            }
        },
        getters: {
            isTokenValid(state) {
                return state.token && state.tokenExpiry && Date.now() < state.tokenExpiry;
            }
        },
        actions: {
            async login({ commit }, { kullanici, isyeriKodu, sifre }) {
                try {
                    const soap = `<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:web="http://www.sgk.gov.tr/">
      <soapenv:Header/>
      <soapenv:Body>
        <web:wsLogin>
          <web:kullaniciAdi>${kullanici}</web:kullaniciAdi>
          <web:isyeriKodu>${isyeriKodu}</web:isyeriKodu>
          <web:isyeriSifresi>${sifre}</web:isyeriSifresi>
        </web:wsLogin>
      </soapenv:Body>
    </soapenv:Envelope>`;

                    const res = await fetch('https://uyg.sgk.gov.tr/Ws_Vizite/services/ViziteGonder', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'text/xml;charset=UTF-8',
                            'SOAPAction': 'http://www.sgk.gov.tr/wsLogin'
                        },
                        body: soap
                    });

                    if (!res.ok) {
                        throw new Error(`HTTP Error: ${res.status} ${res.statusText}`);
                    }

                    const text = await res.text();
                    console.log('Login Response:', text);

                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(text, 'text/xml');

                    // Check for SOAP fault
                    const faultCode = xmlDoc.querySelector('faultcode');
                    if (faultCode) {
                        const faultString = xmlDoc.querySelector('faultstring')?.textContent || 'Unknown SOAP fault';
                        throw new Error(`SOAP Fault: ${faultString}`);
                    }

                    // Try different possible token element names
                    let tokenElement = xmlDoc.querySelector('wsToken') ||
                        xmlDoc.querySelector('token') ||
                        xmlDoc.querySelector('wsTokenReturn');

                    if (tokenElement && tokenElement.textContent) {
                        const token = tokenElement.textContent;
                        const expiry = Date.now() + 30 * 60 * 1000; // 30 minutes
                        commit('setToken', { token, expiry });
                        commit('setResponse', 'Giriş başarılı!');
                        return { success: true, message: 'Giriş başarılı!' };
                    } else {
                        // Check for error codes
                        const sonucKod = xmlDoc.querySelector('sonucKod')?.textContent;
                        const sonucAciklama = xmlDoc.querySelector('sonucAciklama')?.textContent;

                        if (sonucKod && sonucKod !== '0') {
                            const errorMsg = sonucAciklama || `Hata Kodu: ${sonucKod}`;
                            commit('setResponse', errorMsg);
                            return { success: false, message: errorMsg };
                        }

                        commit('setResponse', 'Token alınamadı. Kullanıcı bilgilerinizi kontrol ediniz.');
                        return { success: false, message: 'Token alınamadı' };
                    }
                } catch (e) {
                    console.error('Login Error:', e);
                    const errorMsg = `Giriş Hatası: ${e.message}`;
                    commit('setResponse', errorMsg);
                    return { success: false, message: errorMsg };
                }
            },

            async raporSorgula({ state, getters }) {
                if (!getters.isTokenValid) {
                    throw new Error('Geçersiz token. Lütfen tekrar giriş yapın.');
                }

                try {
                    const tarih = new Date().toISOString().slice(0, 10).split('-').reverse().join('.');
                    const soap = `<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:web="http://www.sgk.gov.tr/">
      <soapenv:Header/>
      <soapenv:Body>
        <web:raporAramaTarihile>
          <web:kullaniciAdi>DUMMY</web:kullaniciAdi>
          <web:isyeriKodu>1234</web:isyeriKodu>
          <web:wsToken>${state.token}</web:wsToken>
          <web:tarih>${tarih}</web:tarih>
        </web:raporAramaTarihile>
      </soapenv:Body>
    </soapenv:Envelope>`;

                    const res = await fetch('https://uyg.sgk.gov.tr/Ws_Vizite/services/ViziteGonder', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'text/xml;charset=UTF-8',
                            'SOAPAction': 'http://www.sgk.gov.tr/raporAramaTarihile'
                        },
                        body: soap
                    });

                    if (!res.ok) {
                        throw new Error(`HTTP Error: ${res.status} ${res.statusText}`);
                    }
                    const text = await res.text();
                    return text;
                } catch (e) {
                    throw e;
                }
            }
        }
    });

    // Helper functions for SOAP operations
    async function raporOnayla(params) {
        alert(JSON.stringify(params))
        try {
            const soap = `<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:web="http://www.sgk.gov.tr/">
        <soapenv:Header/>
        <soapenv:Body>
            <web:raporOnay>
                <web:kullaniciAdi>${params.kullaniciAdi}</web:kullaniciAdi>
                <web:isyeriKodu>${params.isyeriKodu}</web:isyeriKodu>
                <web:wsToken>${params.wsToken}</web:wsToken>
                <web:tckNo>${params.tckNo}</web:tckNo>
                <web:vaka>${params.vaka}</web:vaka>
                <web:medulaRaporId>${params.medulaRaporId}</web:medulaRaporId>
                <web:nitelikDurumu>0</web:nitelikDurumu>
                <web:tarih>${params.tarih}</web:tarih>
            </web:raporOnay>
        </soapenv:Body>
    </soapenv:Envelope>`;

            const res = await fetch('https://uyg.sgk.gov.tr/Ws_Vizite/services/ViziteGonder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/xml;charset=UTF-8',
                    'SOAPAction': 'http://www.sgk.gov.tr/raporOnay'
                },
                body: soap
            });

            if (!res.ok) {
                throw new Error(`HTTP Error: ${res.status} ${res.statusText}`);
            }

            const text = await res.text();
            console.log('Rapor Onayla Response:', text);

            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(text, 'text/xml');

            const sonucKod = xmlDoc.querySelector('sonucKod')?.textContent;
            const sonucAciklama = xmlDoc.querySelector('sonucAciklama')?.textContent;

            if (sonucKod === '0') {
                return { success: true, message: 'Rapor başarıyla onaylandı!' };
            } else {
                return {
                    success: false,
                    message: sonucAciklama || `Rapor Onaylama Hatası (Kod: ${sonucKod})`
                };
            }
        } catch (e) {
            console.error('Rapor Onayla Error:', e);
            return { success: false, message: `Rapor Onaylama Hatası: ${e.message}` };
        }
    }

    async function raporKapat(params) {
        try {
            const soap = `<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:web="http://www.sgk.gov.tr/">
        <soapenv:Header/>
        <soapenv:Body>
            <web:raporOkunduKapat>
                <web:kullaniciAdi>${params.kullaniciAdi}</web:kullaniciAdi>
                <web:isyeriKodu>${params.isyeriKodu}</web:isyeriKodu>
                <web:wsToken>${params.wsToken}</web:wsToken>
                <web:medulaRaporId>${params.medulaRaporId}</web:medulaRaporId>
            </web:raporOkunduKapat>
        </soapenv:Body>
    </soapenv:Envelope>`;

            const res = await fetch('https://uyg.sgk.gov.tr/Ws_Vizite/services/ViziteGonder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/xml;charset=UTF-8',
                    'SOAPAction': 'http://www.sgk.gov.tr/raporOkunduKapat'
                },
                body: soap
            });

            if (!res.ok) {
                throw new Error(`HTTP Error: ${res.status} ${res.statusText}`);
            }

            const text = await res.text();
            console.log('Rapor Kapat Response:', text);

            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(text, 'text/xml');

            const sonucKod = xmlDoc.querySelector('sonucKod')?.textContent;
            const sonucAciklama = xmlDoc.querySelector('sonucAciklama')?.textContent;

            if (sonucKod === '0') {
                return { success: true, message: 'Rapor başarıyla kapatıldı!' };
            } else {
                return {
                    success: false,
                    message: sonucAciklama || `Rapor Kapatma Hatası (Kod: ${sonucKod})`
                };
            }
        } catch (e) {
            console.error('Rapor Kapat Error:', e);
            return { success: false, message: `Rapor Kapatma Hatası: ${e.message}` };
        }
    }

    async function raporPersonelimDegil(params) {
        try {
            const soap = `<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:web="http://www.sgk.gov.tr/">
        <soapenv:Header/>
        <soapenv:Body>
            <web:personelimDegildir>
                <web:kullaniciAdi>${params.kullaniciAdi}</web:kullaniciAdi>
                <web:isyeriKodu>${params.isyeriKodu}</web:isyeriKodu>
                <web:wsToken>${params.wsToken}</web:wsToken>
                <web:tckNo>${params.tckNo}</web:tckNo>
                <web:vaka>${params.vaka}</web:vaka>
                <web:medulaRaporId>${params.medulaRaporId}</web:medulaRaporId>
            </web:personelimDegildir>
        </soapenv:Body>
    </soapenv:Envelope>`;

            const res = await fetch('https://uyg.sgk.gov.tr/Ws_Vizite/services/ViziteGonder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/xml;charset=UTF-8',
                    'SOAPAction': 'http://www.sgk.gov.tr/personelimDegildir'
                },
                body: soap
            });

            if (!res.ok) {
                throw new Error(`HTTP Error: ${res.status} ${res.statusText}`);
            }

            const text = await res.text();
            console.log('Personelim Değil Response:', text);

            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(text, 'text/xml');

            const sonucKod = xmlDoc.querySelector('sonucKod')?.textContent;
            const sonucAciklama = xmlDoc.querySelector('sonucAciklama')?.textContent;

            if (sonucKod === '0' || sonucKod === '600') {
                return { success: true, message: 'İşlem başarıyla tamamlandı!' };
            } else {
                return {
                    success: false,
                    message: sonucAciklama || `İşlem Hatası (Kod: ${sonucKod})`
                };
            }
        } catch (e) {
            console.error('Personelim Değil Error:', e);
            return { success: false, message: `İşlem Hatası: ${e.message}` };
        }
    }

    // Vaka kod mapping
    function getVakaKodu(vakaAdi) {
        const vakaMap = {
            'İş Kazası': '1',
            'Meslek Hastalığı': '2',
            'Hastalık': '3',
            'Analık': '4'
        };
        return vakaMap[vakaAdi] || '3';
    }

    new Vue({
        el: '#app',
        store,
        components: { HotTable },
        data: {
            // Handsontable configuration
            colHeaders: [
            'İş Yeri Adı',
            'Kullanıcı Adı',
            'Kullanıcı Kodu',
            'Sistem Şifresi',
            'İşyeri Şifresi',
            'İşlemler'
          ],
            tableData: [],
            columns: [
                { type: 'text', width: 200 },
                { type: 'text', width: 150 },
                { type: 'text', width: 120 },
                { type: 'text', width: 120 },
                { type: 'text', width: 120 },
                {
                    readOnly: true,
                    width: 100,
                    renderer: (instance, td, row, col, prop, value) => {
                        const rowData = instance.getDataAtRow(row) || [];
                        const isyeriAdi = rowData[0];
                        const kullanici = rowData[1];
                        const isyeriKodu = rowData[2];
                        const sifre = rowData[4];

                        if (kullanici && kullanici.trim() !== '' && 
                            isyeriKodu && isyeriKodu.trim() !== '' && 
                            sifre && sifre.trim() !== '') {
                            
                            td.innerHTML = '<button class="btn btn-primary btn-sm">Raporlar</button>';
                            td.style.textAlign = 'center';

                            const button = td.querySelector('button');
                            if (button) {
                                button.onclick = () => {
                                    // Get the Vue instance
                                    const vueApp = document.querySelector('#app').__vue__;
                                    vueApp.loginWithRowData({
                                        isyeriAdi: isyeriAdi || '',
                                        kullanici: kullanici,
                                        isyeriKodu: isyeriKodu,
                                        sifre: sifre
                                    });
                                };
                            }
                        } else {
                            td.innerHTML = '';
                        }
                        return td;
                    }
                }
            ],
            
            // Login and user data
            currentUser: {},
            loginMessage: '',
            loginSuccess: false,
            isLoading: false,
            
            // Report data
            raporlar: [],
            search: '',
            selectedRapor: null,
            modalLoading: false,
            modalMessage: '',
            modalSuccess: false
        },
        
        computed: {
            token() {
                return this.$store.state.token;
            },
            response() {
                return this.$store.state.response;
            },
            filteredRaporlar() {
                if (!this.search) return this.raporlar;
                const term = this.search.toLowerCase();
                return this.raporlar.filter(r =>
                    Object.values(r).some(val =>
                        String(val).toLowerCase().includes(term)
                    )
                );
            }
        },
        
        watch: {
            token(newToken) {
                if (newToken) {
                    this.loginSuccess = true;
                    // Auto load reports after login
                    setTimeout(() => {
                        this.raporSorgula();
                    }, 1000);
                }
            }
        },
        
        methods: {
            onTableChange(changes, source) {
                // Handle table data changes if needed
                console.log('Table changed:', changes, source);
            },
            
            async loginWithRowData(rowData) {
                if (!rowData.kullanici || !rowData.isyeriKodu || !rowData.sifre) {
                    this.loginMessage = 'Kullanıcı adı, işyeri kodu ve şifre alanları doldurulmalıdır.';
                    this.loginSuccess = false;
                    return;
                }
                
                this.isLoading = true;
                this.loginMessage = '';
                this.loginSuccess = false;
                this.currentUser = rowData;
                
                try {
                    const result = await this.$store.dispatch('login', {
                        kullanici: rowData.kullanici,
                        isyeriKodu: rowData.isyeriKodu,
                        sifre: rowData.sifre
                    });
                    
                    this.loginSuccess = result.success;
                    this.loginMessage = result.message;
                    
                } catch (e) {
                    console.error('Login failed:', e);
                    this.loginSuccess = false;
                    this.loginMessage = `Giriş hatası: ${e.message}`;
                } finally {
                    this.isLoading = false;
                }
            },
            
            logout() {
                this.$store.commit('clearToken');
                this.raporlar = [];
                this.selectedRapor = null;
                this.search = '';
                this.modalMessage = '';
                this.loginSuccess = false;
                this.loginMessage = '';
                this.currentUser = {};
            },
            
            showRapor(rapor) {
                this.selectedRapor = rapor;
                this.modalMessage = '';
                this.modalSuccess = false;
            },
            
            async raporSorgula() {
                if (!this.$store.getters.isTokenValid) {
                    this.$store.commit('setResponse', 'Token süresi dolmuş. Lütfen tekrar giriş yapın.');
                    this.logout();
                    return;
                }

                this.isLoading = true;

                try {
                    const xmlText = await this.$store.dispatch('raporSorgula');
                    if (xmlText) {
                        this.parseRaporXML(xmlText);
                    }
                } catch (e) {
                    console.error('Rapor sorgula error:', e);
                    this.$store.commit('setResponse', `Rapor sorgulama hatası: ${e.message}`);

                    if (e.message.includes('token') || e.message.includes('Token')) {
                        this.logout();
                    }
                } finally {
                    this.isLoading = false;
                }
            },
            
            async modalRaporOnayla() {
                if (!this.selectedRapor || !this.token) return;

                this.modalLoading = 'onayla';
                this.modalMessage = '';

                try {
                    const vakaKodu = getVakaKodu(this.selectedRapor.VAKAADI);
                    const result = await raporOnayla({
                        kullaniciAdi: this.currentUser.kullanici,
                        isyeriKodu: this.currentUser.isyeriKodu,
                        wsToken: this.token,
                        tckNo: this.selectedRapor.TCKIMLIKNO,
                        vaka: vakaKodu,
                        medulaRaporId: this.selectedRapor.MEDULARAPORID,
                        tarih: this.selectedRapor.ABITTAR.slice(0, 10).split('-').reverse().join('.')
                    });

                    this.modalSuccess = result.success;
                    this.modalMessage = result.message;

                    if (result.success) {
                        // Refresh reports after successful operation
                        setTimeout(() => {
                            this.raporSorgula();
                        }, 2000);
                    }
                } catch (e) {
                    this.modalSuccess = false;
                    this.modalMessage = `İşlem hatası: ${e.message}`;
                } finally {
                    this.modalLoading = false;
                }
            },

            async modalRaporKapat() {
                if (!this.selectedRapor || !this.token) return;

                this.modalLoading = 'kapat';
                this.modalMessage = '';

                try {
                    const result = await raporKapat({
                        kullaniciAdi: this.currentUser.kullanici,
                        isyeriKodu: this.currentUser.isyeriKodu,
                        wsToken: this.token,
                        medulaRaporId: this.selectedRapor.MEDULARAPORID
                    });

                    this.modalSuccess = result.success;
                    this.modalMessage = result.message;

                    if (result.success) {
                        // Refresh reports after successful operation
                        setTimeout(() => {
                            this.raporSorgula();
                        }, 2000);
                    }
                } catch (e) {
                    this.modalSuccess = false;
                    this.modalMessage = `İşlem hatası: ${e.message}`;
                } finally {
                    this.modalLoading = false;
                }
            },

            async modalRaporPersonelimDegil() {
                if (!this.selectedRapor || !this.token) return;

                this.modalLoading = 'personelim_degil';
                this.modalMessage = '';

                try {
                    const vakaKodu = getVakaKodu(this.selectedRapor.VAKAADI);
                    const result = await raporPersonelimDegil({
                        kullaniciAdi: this.currentUser.kullanici,
                        isyeriKodu: this.currentUser.isyeriKodu,
                        wsToken: this.token,
                        tckNo: this.selectedRapor.TCKIMLIKNO,
                        vaka: vakaKodu,
                        medulaRaporId: this.selectedRapor.MEDULARAPORID
                    });

                    this.modalSuccess = result.success;
                    this.modalMessage = result.message;

                    if (result.success) {
                        // Refresh reports after successful operation
                        setTimeout(() => {
                            this.raporSorgula();
                        }, 2000);
                    }
                } catch (e) {
                    this.modalSuccess = false;
                    this.modalMessage = `İşlem hatası: ${e.message}`;
                } finally {
                    this.modalLoading = false;
                }
            },
            
            parseRaporXML(xmlText) {
                try {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlText, 'text/xml');

                    // Check for parsing errors
                    const parseError = xmlDoc.querySelector('parsererror');
                    if (parseError) {
                        throw new Error('XML parsing error: ' + parseError.textContent);
                    }

                    // Check for SOAP fault
                    const faultCode = xmlDoc.querySelector('faultcode');
                    if (faultCode) {
                        const faultString = xmlDoc.querySelector('faultstring')?.textContent || 'Unknown SOAP fault';
                        throw new Error(`SOAP Fault: ${faultString}`);
                    }

                    // Check for error response
                    const sonucKod = xmlDoc.querySelector('sonucKod')?.textContent;
                    const sonucAciklama = xmlDoc.querySelector('sonucAciklama')?.textContent;

                    if (sonucKod && sonucKod !== '0') {
                        const errorMsg = sonucAciklama || `Hata Kodu: ${sonucKod}`;
                        this.$store.commit('setResponse', errorMsg);
                        return;
                    }

                    // Try to find report data with different possible element names
                    let nodes = xmlDoc.querySelectorAll('RaporAramaTarihleBean') ||
                        xmlDoc.querySelectorAll('raporAramaTarihileBeans') ||
                        xmlDoc.querySelectorAll('rapor');

                    const temp = [];
                    const raporDurumuMap = {
                        '1': 'Çalışır',
                        '2': 'Kontrol',
                        '3': 'Devamı Verildi',
                        '4': 'Sevkli',
                        '5': 'Hastane Kapattı',
                        '6': 'Çalışır Olup Çakışma Var',
                        '7': 'Kontrol olup çakışma var',
                        '8': 'Maluliyet Azaltılabilir çalışır',
                        '9': 'Maluliyet Sevk Çalışır',
                        '10': 'Analık Doğum Öncesi Çalışır',
                        '11': 'Analık Doğum Öncesi Çalışamaz',
                        '12': 'Analık Doğum Sonrası',
                        '13': 'Maluliyet Azaltılır Kontrol',
                        '14': 'Maluliyet Sevk Kontrol',
                        '15': 'Maluliyet Azaltılır Kontrol Devam Verildi',
                        '16': 'Maluliyet Sevk Kontrol Devam Verildi'
                    };

                    for (let i = 0; i < nodes.length; i++) {
                        const n = nodes[i];
                        const raporCode = this.getElementText(n, 'RAPORDURUMU');

                        temp.push({
                            TCKIMLIKNO: this.getElementText(n, 'TCKIMLIKNO'),
                            AD: this.getElementText(n, 'AD'),
                            SOYAD: this.getElementText(n, 'SOYAD'),
                            MEDULARAPORID: this.getElementText(n, 'MEDULARAPORID'),
                            RAPORTAKIPNO: this.getElementText(n, 'RAPORTAKIPNO'),
                            RAPORSIRANO: this.getElementText(n, 'RAPORSIRANO'),
                            POLIKLINIKTAR: this.getElementText(n, 'POLIKLINIKTAR'),
                            ABASTAR: this.getElementText(n, 'ABASTAR'),
                            ABITTAR: this.getElementText(n, 'ABITTAR'),
                            RAPORDURUMU: raporDurumuMap[raporCode] || raporCode,
                            VAKAADI: this.getElementText(n, 'VAKAADI'),
                            VAKA: this.getElementText(n, 'VAKA'),
                            ARSIV: (this.getElementText(n, 'ARSIV') || '').trim() === '1'
                        });
                    }

                    this.raporlar = temp;
                    this.$store.commit('setResponse',
                        temp.length > 0
                            ? `${temp.length} rapor bulundu.`
                            : 'Sorguladığınız tarih aralığında kayıt bulunamadı.'
                    );

                } catch (e) {
                    console.error('XML Parse Error:', e);
                    this.$store.commit('setResponse', `XML Parse Hatası: ${e.message}`);
                    this.raporlar = [];
                }
            },
            
            getElementText(parent, tagName) {
                const element = parent.querySelector(tagName);
                return element ? element.textContent.trim() : '';
            },
            
            formatDate(val) {
                if (!val) return '';

                // Handle different date formats
                if (/^\d{4}-\d{2}-\d{2}$/.test(val)) {
                    // YYYY-MM-DD format
                    return val.split('-').reverse().join('.');
                } else if (/^\d{2}\.\d{2}\.\d{4}$/.test(val)) {
                    // Already in DD.MM.YYYY format
                    return val;
                } else if (val.includes('T')) {
                    // ISO datetime format
                    const date = new Date(val);
                    return date.toLocaleDateString('tr-TR');
                }

                return val;
            }
        },
        
        mounted() {
            // Check if token is still valid on app start
            if (this.$store.getters.isTokenValid) {
                this.raporSorgula();
            }
        }
    });
    </script>
    <script>
    // İnternet bağlantısı kontrolü
    function checkInternet() {
        // CDN'den küçük bir dosya isteği
        fetch('https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js', {method:'HEAD', cache:'no-store'})
            .then(function(resp) {
                if (resp.ok) {
                    document.getElementById('app').style.display = '';
                    document.getElementById('no-internet').style.display = 'none';
                } else {
                    throw new Error('Bağlantı yok');
                }
            })
            .catch(function() {
                document.getElementById('app').style.display = 'none';
                document.getElementById('no-internet').style.display = 'flex';
            });
    }
    window.addEventListener('DOMContentLoaded', checkInternet);
    </script>
    <script>
    // İnternet bağlantısı kontrolü
    function checkInternet() {
        // CDN'den küçük bir dosya isteği
        fetch('https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js', {method:'HEAD', cache:'no-store'})
            .then(function(resp) {
                if (resp.ok) {
                    document.getElementById('app').style.display = '';
                    document.getElementById('no-internet').style.display = 'none';
                } else {
                    throw new Error('Bağlantı yok');
                }
            })
            .catch(function() {
                document.getElementById('app').style.display = 'none';
                document.getElementById('no-internet').style.display = 'flex';
            });
    }
    window.addEventListener('DOMContentLoaded', checkInternet);
    </script>
</body>
</html>





